import kotlin.collections.List;

CREATE TABLE MyShow (
    tmdbId INTEGER AS Int NOT NULL,
    imdbId TEXT,
    tvdbId INTEGER AS Int,
    facebookId TEXT,
    instagramId TEXT,
    twitterId TEXT,
    name TEXT NOT NULL,
    overview TEXT NOT NULL,
    year INTEGER as Int,
    lastYear INTEGER as Int,
    imageUrl TEXT,
    homePageUrl TEXT,
    genres TEXT AS List<String> NOT NULL,
    networks TEXT AS List<String> NOT NULL,
    contentRating TEXT,
    isEnded INTEGER AS Boolean NOT NULL,
    nextEpisodeSeason INTEGER AS Int,
    nextEpisodeNumber INTEGER AS Int,
    isArchived INTEGER AS Boolean NOT NULL DEFAULT 0,

    PRIMARY KEY (tmdbId)
);

insert:
INSERT INTO MyShow(imdbId, tmdbId, tvdbId, facebookId, instagramId, twitterId, name, overview, year, lastYear, imageUrl, homePageUrl, genres, networks, contentRating, isEnded, nextEpisodeSeason, nextEpisodeNumber)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

deleteByTmdbId:
DELETE FROM MyShow WHERE tmdbId = ?;

isInMyShows:
SELECT count(*) > 0
FROM MyShow
WHERE tmdbId = ?;

isAddedOrAdding:
SELECT
  (
    (SELECT count(*) FROM MyShow WHERE tmdbId = :showTmdbId) +
    (SELECT count(*) FROM AddToMyShowsTask WHERE showTmdbId = :showTmdbId)
  ) > 0;

isArchived:
SELECT
  (
    (SELECT count(*) FROM MyShow WHERE tmdbId = :showTmdbId AND isArchived = 1) +
    (SELECT count(*) FROM AddToMyShowsTask WHERE showTmdbId = :showTmdbId AND archive = 1)
  ) > 0;

upcomingShows:
SELECT tmdbId, MyShow.name, Episode.name, episodeNumber, seasonNumber, Episode.airDateMillis, Episode.imageUrl
FROM MyShow
INNER JOIN Episode
 ON Episode.showTmdbId = MyShow.tmdbId
 AND Episode.seasonNumber = MyShow.nextEpisodeSeason
 AND Episode.episodeNumber = MyShow.nextEpisodeNumber
WHERE isArchived = 0;

toBeAnnouncedShows:
SELECT tmdbId, name, imageUrl
FROM MyShow
WHERE isEnded = 0
    AND nextEpisodeNumber IS NULL
    AND isArchived = 0;

endedShows:
SELECT tmdbId, name, imageUrl
FROM MyShow
WHERE isEnded = 1 AND isArchived = 0;

archivedShows:
SELECT tmdbId, name, imageUrl
FROM MyShow
WHERE isArchived = 1;

toWatchShows:
SELECT MyShow.tmdbId, MyShow.name, Episode.seasonNumber, Episode.episodeNumber, Episode.name, Episode.imageUrl, NotWatchedEpisodes.count
FROM MyShow
INNER JOIN NotWatchedEpisodes ON NotWatchedEpisodes.showTmdbId = MyShow.tmdbId
INNER JOIN Episode ON Episode.showTmdbId = NotWatchedEpisodes.showTmdbId AND (10000 * Episode.seasonNumber + Episode.episodeNumber) = NotWatchedEpisodes.firstNotWatchedEpisodeIndex
WHERE isArchived = 0;

toWatchShow:
SELECT MyShow.tmdbId, MyShow.name, Episode.seasonNumber, Episode.episodeNumber, Episode.name, Episode.imageUrl, NotWatchedEpisodes.count
FROM MyShow
INNER JOIN NotWatchedEpisodes ON NotWatchedEpisodes.showTmdbId = MyShow.tmdbId
INNER JOIN Episode ON Episode.showTmdbId = NotWatchedEpisodes.showTmdbId AND (10000 * Episode.seasonNumber + Episode.episodeNumber) = NotWatchedEpisodes.firstNotWatchedEpisodeIndex
WHERE MyShow.tmdbId = ?;

showDetails:
SELECT
 MyShow.name,
 MyShow.imageUrl,
 year,
 lastYear,
 isEnded,
 contentRating,
 overview,
 genres,
 networks,
 homePageUrl,
 imdbId,
 facebookId,
 instagramId,
 twitterId
FROM MyShow
WHERE MyShow.tmdbId = ?;

archive:
UPDATE MyShow
SET isArchived = 1
WHERE tmdbId = ?;

unarchive:
UPDATE MyShow
SET isArchived = 0
WHERE tmdbId = ?;
